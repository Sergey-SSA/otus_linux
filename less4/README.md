# Otus-Linux hometask
## Hometask №4
### Bash-scripting

__Данное ДЗ представляет собой набор скриптов а такжке vagrant стенд для тестирования__

__Описание содержания репозитория__
 
__Vagrantfile__ - _файл для запуска стенда vagrant сконфигурированого для проверки ДЗ (выполнение скрипта по крону)_ 

__access-4560-644067.log__ - _основной лог-файл который обрабатывается скриптом_ 

__envfile.txt__ - _файл переменных (используестся в скрипте) здесь хранятся значения последнего запуска скрипта, а также порядковый номер последней считанной строки_ 

__mail.txt__ - _файл письма отправляемого на почту root@localhost (его наличие не играет роли, тк файл динамически формируется при отработке скрипта)_ 

__script.sh__ - _основной скрипт для просмотра и тестирования на локальной машине (если для тестирования используете стенд - этот файл не используется)_ 

__script_vagrant.sh__ - _скрипт модифицированный для запуска в vagrant-стенде. (основная оптимизация касалась запуска из-под крон-а)_ 

__Логика работы скрипта:__ 

Скрипт обрабатывает указанный лог-файл считывая его построчно, анализируя его построчно фильтруя и сортируя при помощи потоковых редакторов
выдавая результат по шаблону и занося его в файл-почты. 
Далее следует отправка файла-письма на почтовый ящик root. 

Скрипт защищен от повторного запуска. Для этого при запуске скрипта создается lock-file в который вносится pid и название процесса со скриптом. 

В случае наличия данного файла в системе и при попытке повторного запуска в консоль будет выведено сообщение о запущенном скрипте и информация о процессе. 

После обработки и выполнения процедуры парсинга лог-файла скрипт автоматически удаляет созданный lock-file, ьем самым позволяя пользователю вручную запустить скрипт. 
В планировщике cron создана задача ежечасного выполнения скрипта. 

Также в качестве эксперимента - в скрипте реализован анализ количества строк файла, 
количество строк считывается из envfile.txt - файл с переменными, далее происходит вычисление общего кол-ва строк лог-файла: 
если файл был обнулен либо перезаписан то обработка начнется с начала файла (с нулевой строки) 
если файл был дописан и появились новые строки с прошедшего запуска скрипта, обработка будет выполнена с последующей строки (последняя считаная из файла +1) 

__В письме отображена статистика:__ 
Количество запросов с ip-адрессов 
Количетво запрошенных страниц 
Количество кодов возврата 
Количество ошибок 
Количество считанных строк из лог-файла 

__Порядок проверки ДЗ__ 

1.Скачать репозиторий  

```
    git cllone https://github.com/kakunindima/otus_linux.git
```

2.Перейти в директорию с ДЗ -> less4 

```
    cd less4/
```

3.Запустить проверочный vagrant-стенд 

```
    vagrant up
```

4.Залогиниться на стенд и переключиться на root 

```
    vagrant ssh
```

```
    sudo -s
```

5.До запуска скрипта ждать час... =) шутка 

6.Файл скрипта доступен для непосредственного запуска в директории: /srv/scripts/otus_linux/less4 

```
    ls -l /srv/scripts/otus_linux/less4
```

```
    /srv/scripts/otus_linux/less4/./script_vagrant.sh
```

7.После выполнения скрипта проверить получение письма для пользователя root 

```
    mail -u root
```

_В письме будет отображена статистика: в соответствии с логикой обработки и выполнения скрипта._ 

8.Проверку от мультизапуска можно провести запустив несколько экземпляров скрипта, в теле скрпта прописана задержка в 15сек что позволит протестировать. 

9.Как дополнительную (ну или основную кому как удобно) проверку предлагаю из лог-файла убрать часть записей, запустить скрипт, просмотреть пришедшее письмо,
добавить остальные строки, и выполнить процедуру повторно, что в свою очередь покажет отработку скрипта. 
В каждом письме будет указан диапазон времени с прошлого - до текущего запуска скрипта. 